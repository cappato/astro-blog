---
import Favicons from '../components/seo/Favicons.astro';
import '../styles/global.css';
import CommonScripts from '../components/layout/CommonScripts.astro';
import { ThemeScript } from '../features/dark-light-mode/components';
import { MetaTags } from '../features/meta-tags/components';
import ImageVariants from '../components/media/ImageVariants.astro';
import { AutoSchema } from '../features/schema';
import { ShareButtons, ShareMessage, CopyToast } from '../features/social-share';

import BlogNavbar from '../components/layout/navbar/BlogNavbar.astro';
import Footer from '../components/layout/footer/Footer.astro';
import TagList from '../components/blog/TagList.astro';
import { getReadingTime, formatReadingTime } from '../features/reading-time';
import { AIMetadata } from '../features/ai-metadata';
import Breadcrumbs from '../features/blog-enhancements/components/Breadcrumbs.astro';
import AuthorCard from '../features/blog-enhancements/components/AuthorCard.astro';
import { generatePostBreadcrumbs, detectPrimaryTag } from '../features/blog-enhancements/utils/breadcrumbs';

import type { CollectionEntry } from 'astro:content';

// Definir la interfaz para las props
interface Props {
  title: string;
  description: string;
  date: Date;
  author: string;
  // Sistema antiguo
  image?: {
    url: string;
    alt: string;
  };
  // Nuevo sistema
  postId?: string;
  imageAlt?: string;
  tags?: string[];
  // Para el nuevo sistema de schemas
  entry?: CollectionEntry<'blog'>;
}

// Props que recibe el componente
const { title, description, date, author, image, postId, imageAlt, tags, entry } = Astro.props;

// Determinar qué sistema de imágenes usar
const useNewImageSystem = !!postId;

// Determinar la imagen para compartir
const shareImage = useNewImageSystem
  ? {
      url: `/images/${postId}/portada-og.webp`,
      alt: imageAlt || title,
      width: 1200,
      height: 630
    }
  : {
      url: image?.url || '',
      alt: image?.alt || title,
      width: 1200,
      height: 630
    };

// Formatear la fecha
const formattedDate = date.toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Calcular tiempo de lectura
const content = await Astro.slots.render('default');
const readingTime = getReadingTime(content);
const readingTimeText = formatReadingTime(readingTime);

// URL actual para compartir
const currentUrl = Astro.url.href;

// Generar breadcrumbs automáticamente
const primaryTag = detectPrimaryTag(tags || []);
const breadcrumbs = generatePostBreadcrumbs(
  Astro.url.pathname,
  title,
  tags || [],
  primaryTag
);
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title} | Matías Cappato</title>

  <!-- Script anti-flicker (debe ir lo antes posible) -->
  <ThemeScript />

  <!-- Meta descripción mejorada y única para cada post -->
  <meta name="description" content={description || `Artículo sobre ${title} por Matías Cappato. ${tags?.join(', ')}`} />

  <!-- Favicons -->
  <Favicons />

  <!-- Unified meta tags component -->
  <MetaTags
    title={title}
    description={description}
    image={shareImage}
    type="article"
    publishedDate={date}
    modifiedDate={date}
    author={author}
    postId={postId}
  />

  <!-- Schema.org JSON-LD para artículos - FULLY AUTOMATED -->
  <AutoSchema post={entry} />

  <!-- Metadatos específicos para IA -->
  <AIMetadata
    title={title}
    description={description}
    type="article"
    url={currentUrl}
    datePublished={date}
    dateModified={date}
    tags={tags || []}
    author={author || "Matías Cappato"}
  />

  <!-- Añadir metadatos adicionales para SEO -->
  {tags && <meta name="keywords" content={tags.join(', ')} />}
  <meta name="author" content={author || "Matías Cappato"} />
  <meta name="robots" content="index, follow" />

  <CommonScripts />
  <link rel="stylesheet" href="/styles/blog.css">
  <style>
    @import '../features/blog-enhancements/styles/blog-enhancements.css';
  </style>
</head>
<body class="font-sans transition-theme">
  <BlogNavbar currentPath={Astro.url.pathname} />

  <!-- Breadcrumbs Navigation -->
  <div class="container mx-auto px-4 pt-4">
    <Breadcrumbs items={breadcrumbs} />
  </div>

  <main id="main-content" class="container mx-auto px-4 py-4">
    <!-- Contenido del artículo -->
    <article class="max-w-3xl mx-auto">
      <!-- Imagen destacada -->
      <div class="w-full h-64 md:h-80 overflow-hidden">
        {useNewImageSystem ? (
          <ImageVariants
            postId={postId}
            type="default"
            alt={imageAlt || title}
            className="w-full h-full object-cover"
            lazy={false}
            fetchpriority="high"
            width={1200}
            height={630}
            debug={import.meta.env.DEV}
          />
        ) : (
          <img
            src={image?.url}
            alt={image?.alt || title}
            width="1200"
            height="630"
            class="w-full h-full object-cover"
            loading="eager"
            fetchpriority="high"
          />
        )}
      </div>

      <div class="p-6">
        <!-- Metadatos del post -->
        <div class="mb-6 border-b divider pb-4">
          <h1 class="text-3xl font-bold text-primary mb-3">{title}</h1>
          <div class="flex flex-wrap items-center text-sm text-muted mb-3">
            <span class="mr-4 flex items-center">
              <i class="fas fa-user mr-1"></i> {author}
            </span>
            <span class="mr-4 flex items-center">
              <i class="fas fa-calendar mr-1"></i> {formattedDate}
            </span>
            <span class="flex items-center">
              <i class="fas fa-clock mr-1"></i> {readingTimeText}
            </span>
          </div>

          <!-- Barra de compartir horizontal (componente) -->
          <ShareButtons url={currentUrl} title={title} compact={true} />

          <!-- Tags -->
          {tags && tags.length > 0 && (
            <TagList tags={tags} />
          )}
        </div>

        <!-- Contenido del post -->
        <div class="prose prose-lg max-w-none dark:prose-invert">
          <slot />
        </div>

        <!-- Módulo de Autor -->
        <AuthorCard variant="full" showRelatedPosts={true} />

        <!-- Botones para compartir -->
        <div class="mt-8 pt-6 border-t border-border dark:border-border-dark">
          <h3 class="text-lg font-medium mb-4 text-primary-content">¿Te gustó este artículo? ¡Compártelo!</h3>

          <!-- Componente de botones para compartir (versión completa) -->
          <ShareButtons url={currentUrl} title={title} compact={false} showTitle={false} />

          <!-- Componente de mensaje para compartir -->
          <div class="mt-6">
            <ShareMessage
              title={title}
              description={description}
              url={currentUrl}
              tags={tags}
            />
          </div>
        </div>
      </div>
    </article>
  </main>

  <!-- Usar el mismo componente Footer que funciona en la home -->
  <Footer />

  <!-- Componente de toast para notificaciones de copia -->
  <CopyToast />
</body>
</html>


