---
import BaseLayout from '../../../components/layout/BaseLayout.astro';
import { getCollection } from 'astro:content';
import TagButton from '../../../components/ui/TagButton.astro';
import BlogNavbar from '../../../components/layout/navbar/BlogNavbar.astro';
import Footer from '../../../components/layout/footer/Footer.astro';
import BlogPostCard from '../../../components/blog/BlogPostCard.astro';
import {
  getAllTags,
  getPostsByTag,
  transformPostsToCardData,
  getTagSeoData
} from '../../../utils/blogPost.ts';

// Static paths generation for dynamic routes
export async function getStaticPaths() {
  const allPosts = await getCollection('blog');

  // Extract all unique tags from all posts
  const uniqueTags = getAllTags(allPosts);

  // Create a route for each tag
  return uniqueTags.map(tag => ({
    params: { tag },
    props: { tag }
  }));
}

// Get tag from props
const { tag } = Astro.props;

// Get all posts
const allPosts = await getCollection('blog');

// Get posts filtered by tag
const posts = getPostsByTag(allPosts, tag);

// Transform posts to card data
const postCards = transformPostsToCardData(posts);

// SEO metadata
const { title, description } = getTagSeoData(tag);
---

<BaseLayout
  title={title}
  description={description}
  image="/images/blog-cover.webp"
  imageAlt={`Artículos sobre ${tag} en el blog de Matías Cappato`}
  type="website"
  keywords={[tag, "blog", "desarrollo web", "programación"]}
  customTitle={`#${tag}`}
>
  <link rel="stylesheet" href="/styles/blog.css" slot="head">

  <BlogNavbar currentPath={`/blog/tag/${tag}`} slot="header" />

  <main class="container mx-auto px-4 py-8">
    <!-- Mostrar la etiqueta actual con un tamaño más grande -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2 text-content">Artículos con la etiqueta</h1>
      <TagButton tag={tag} />
    </div>

    <!-- Posts list with tag filter -->
    {postCards.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {postCards.map((postCard, index) => (
          <BlogPostCard
            post={postCard}
            loading={index < 3 ? 'eager' : 'lazy'}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-xl text-primary-content opacity-75">No hay artículos con esta etiqueta aún.</p>
      </div>
    )}
  </main>

  <Footer slot="footer" />
</BaseLayout>


