name: Conventional Commits Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-commits:
    name: Validate Conventional Commits
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Validate commit messages
      uses: actions/github-script@v7
      with:
        script: |
          const commits = await github.rest.repos.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.payload.pull_request.head.sha,
            per_page: 100
          });
          
          const conventionalPattern = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?: .{1,50}/;
          const analysis = {
            total: commits.data.length,
            conventional: 0,
            issues: []
          };
          
          const commitTypes = {};
          
          for (const commit of commits.data) {
            const message = commit.commit.message.split('\n')[0];
            
            if (conventionalPattern.test(message)) {
              analysis.conventional++;
              const type = message.split(':')[0].split('(')[0];
              commitTypes[type] = (commitTypes[type] || 0) + 1;
            } else {
              analysis.issues.push({
                sha: commit.sha.substring(0, 7),
                message: message
              });
            }
          }
          
          const typesList = Object.entries(commitTypes)
            .map(([type, count]) => `- **${type}**: ${count}`)
            .join('\n');
          
          const issuesList = analysis.issues
            .map(issue => `- \`${issue.sha}\`: ${issue.message}`)
            .join('\n');
          
          // Only fail if there are non-conventional commits
          if (analysis.issues.length > 0) {
            const failureMessage = `❌ Found ${analysis.issues.length} non-conventional commits:\n${issuesList}`;
            console.log(failureMessage);
            core.setFailed('Some commits do not follow conventional commit format');
          } else {
            console.log(`✅ All ${analysis.total} commits follow conventional format`);
          }
